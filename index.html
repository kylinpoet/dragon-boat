<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¾™èˆŸåŠ¨ä½œè¯†åˆ«ç³»ç»Ÿ</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 20px;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .webcam-container {
            display: flex;
            justify-content: center;
            margin: 15px 0;
            position: relative;
        }
        #canvas {
            border-radius: 4px;
            border: 2px solid #3498db;
            width: 400px;
            height: 400px;
        }
        #process-canvas {
            position: absolute;
            left: -9999px;
            width: 200px;
            height: 200px;
        }
        .controls {
            text-align: center;
            margin: 15px 0;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        .performance-hint {
            text-align: center;
            font-size: 12px;
            color: #7f8c8d;
            margin: 5px 0;
        }
        .predictions {
            margin-top: 15px;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            opacity: 0.7;
        }
        .prediction-item {
            background-color: #ecf0f1;
            padding: 8px;
            border-radius: 4px;
            font-size: 14px;
        }
        .prediction-label {
            font-weight: bold;
            margin-bottom: 3px;
        }
        .progress-bar {
            height: 15px;
            background-color: #e0e0e0;
            border-radius: 8px;
            overflow: hidden;
        }
        .progress {
            height: 100%;
            background-color: #2ecc71;
            width: 0%;
            transition: width 0.2s;
        }
        .feedback {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            background-color: #f8f9fa;
            border-left: 4px solid #3498db;
            text-align: center;
        }
        .action-sequence {
            margin-top: 15px;
            font-weight: bold;
            font-size: 18px;
            text-align: center;
        }
        .correct {
            color: #27ae60;
        }
        .incorrect {
            color: #e74c3c;
        }
        .progress-container {
            margin-top: 15px;
            text-align: center;
        }
        .progress-text {
            margin-bottom: 5px;
            font-weight: bold;
        }
        .completion-bar {
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 0 auto;
            width: 80%;
            position: relative;
            display: flex; /* ä½¿ç”¨flexå¸ƒå±€ä½¿åˆ†æ®µå¹¶æ’ */
        }
        .completion-segment {
            height: 100%;
            transition: width 0.3s;
        }
        .segment-start {
            background-color: #3498db; /* è“è‰²è¡¨ç¤ºèµ·æ‰‹å¼ */
            width: 0%; /* åˆå§‹å®½åº¦ä¸º0 */
        }
        .segment-enter {
            background-color: #f1c40f; /* é»„è‰²è¡¨ç¤ºå…¥æ°´å¼ */
            width: 0%; /* åˆå§‹å®½åº¦ä¸º0 */
        }
        .segment-pull {
            background-color: #2ecc71; /* ç»¿è‰²è¡¨ç¤ºæ‹‰æ¡¨å¼ */
            width: 0%; /* åˆå§‹å®½åº¦ä¸º0 */
        }
        .counter {
            margin-top: 10px;
            font-size: 16px;
            font-weight: bold;
            color: #2c3e50;
        }
        .success-counter {
            margin-top: 15px;
            font-size: 20px;
            font-weight: bold;
            color: #27ae60;
            text-align: center;
            padding: 10px;
            background-color: #e8f8f0;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .legend {
            display: flex;
            justify-content: center;
            margin-top: 10px;
            gap: 15px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            font-size: 14px;
        }
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
            margin-right: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>é¾™èˆŸåŠ¨ä½œè¯†åˆ«ç³»ç»Ÿ</h1>
        
        <div class="controls">
            <button type="button" onclick="init()">å¼€å§‹è¯†åˆ«</button>
            <div class="performance-hint">æç¤ºï¼šç¡®ä¿æ‘„åƒå¤´æ¸…æ™°å¯è§ï¼ŒåŠ¨ä½œè¿è´¯æµç•…</div>
        </div>
        
        <div class="webcam-container">
            <canvas id="canvas"></canvas>
            <canvas id="process-canvas"></canvas>
        </div>
        
        <div class="progress-container">
            <div class="progress-text">åŠ¨ä½œå®Œæˆè¿›åº¦</div>
            <div class="completion-bar" id="completion-bar">
                <div class="completion-segment segment-start" id="segment-start"></div>
                <div class="completion-segment segment-enter" id="segment-enter"></div>
                <div class="completion-segment segment-pull" id="segment-pull"></div>
            </div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #3498db;"></div>
                    <span>èµ·æ‰‹å¼</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #f1c40f;"></div>
                    <span>å…¥æ°´å¼</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: #2ecc71;"></div>
                    <span>æ‹‰æ¡¨å¼</span>
                </div>
            </div>
            <div class="counter">å½“å‰åŠ¨ä½œåºåˆ—: <span id="current-sequence">æ— </span></div>
        </div>
        
        <div class="success-counter">
            æˆåŠŸå®Œæˆåˆ’æ¡¨åŠ¨ä½œ: <span id="completed-count">0</span> æ¬¡
        </div>
        
        <div class="feedback" id="feedback">
            <p>ç­‰å¾…åŠ¨ä½œè¯†åˆ«...</p>
            <div class="action-sequence" id="action-sequence"></div>
        </div>
        
        <div class="predictions" id="label-container"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.3.1/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@teachablemachine/pose@0.8/dist/teachablemachine-pose.min.js"></script>
    <script type="text/javascript">
        // æ¨¡å‹URL
        const URL = "./my_model/";
        let model, webcam, ctx, processCtx, labelContainer, maxPredictions;
        let isRunning = false;
        
        // åŠ¨ä½œå®šä¹‰ï¼ˆæ³¨æ„é¡ºåºä¸æ¨¡å‹æ ‡ç­¾IDä¸€è‡´ï¼‰
        const ACTIONS = {
            ENTER: "å…¥æ°´å¼",
            START: "èµ·æ‰‹å¼",
            NORMAL: "å¹³å¤å¼",
            PULL: "æ‹‰æ¡¨å¼"
        };
        
        // æ­£ç¡®åŠ¨ä½œåºåˆ—
        const CORRECT_SEQUENCE = [ACTIONS.START, ACTIONS.ENTER, ACTIONS.PULL];
        
        // åŠ¨ä½œè®°å½•
        let actionHistory = [];
        let currentSequence = [];
        let isSequenceCorrect = false;
        let lastActionTime = 0;
        const SEQUENCE_TIMEOUT = 1500; // 1.5ç§’å†…å®ŒæˆåŠ¨ä½œåºåˆ—
        let frameCount = 0;
        const FRAME_SKIP = 2; // æ¯3å¸§å¤„ç†ä¸€æ¬¡ï¼Œå‡å°‘è®¡ç®—é‡
        let completedCount = 0; // å®Œæˆæ¬¡æ•°è®¡æ•°å™¨

        async function init() {
            if (isRunning) return;
            isRunning = true;
            
            const modelURL = URL + "model.json";
            const metadataURL = URL + "metadata.json";

            try {
                // é‡ç½®è®¡æ•°å™¨
                completedCount = 0;
                document.getElementById('completed-count').textContent = "0";
                
                // åŠ è½½æ¨¡å‹å’Œå…ƒæ•°æ®
                model = await tmPose.load(modelURL, metadataURL);
                maxPredictions = model.getTotalClasses();

                // è®¾ç½®æ‘„åƒå¤´
                const size = 200; // å®é™…å¤„ç†å¤§å°ä¸º200x200
                const flip = true;
                webcam = new tmPose.Webcam(size, size, flip);
                await webcam.setup();
                await webcam.play();
                window.requestAnimationFrame(loop);

                // è·å–DOMå…ƒç´ 
                const canvas = document.getElementById("canvas");
                const processCanvas = document.getElementById("process-canvas");
                canvas.width = 400; 
                canvas.height = 400;
                processCanvas.width = size;
                processCanvas.height = size;
                ctx = canvas.getContext("2d");
                processCtx = processCanvas.getContext("2d");
                labelContainer = document.getElementById("label-container");
                
                // æ¸…ç©ºæ ‡ç­¾å®¹å™¨
                labelContainer.innerHTML = '';
                
                // åˆ›å»ºé¢„æµ‹ç»“æœæ˜¾ç¤ºå…ƒç´ 
                for (let i = 0; i < maxPredictions; i++) {
                    const predictionItem = document.createElement("div");
                    predictionItem.className = "prediction-item";
                    
                    const label = document.createElement("div");
                    label.className = "prediction-label";
                    label.textContent = Object.values(ACTIONS)[i];
                    
                    const progressContainer = document.createElement("div");
                    progressContainer.className = "progress-bar";
                    
                    const progress = document.createElement("div");
                    progress.className = "progress";
                    progress.id = `progress-${i}`;
                    
                    progressContainer.appendChild(progress);
                    predictionItem.appendChild(label);
                    predictionItem.appendChild(progressContainer);
                    labelContainer.appendChild(predictionItem);
                }
                
                // åˆå§‹åŒ–è¿›åº¦æ¡ä¸º0
                resetProgressBar();
                
                updateFeedback("ç³»ç»Ÿå·²å¯åŠ¨ï¼Œè¯·å¼€å§‹åˆ’æ¡¨åŠ¨ä½œ", false);
            } catch (error) {
                console.error("åˆå§‹åŒ–é”™è¯¯:", error);
                updateFeedback("åˆå§‹åŒ–å¤±è´¥: " + error.message, false);
                isRunning = false;
            }
        }

        // é‡ç½®è¿›åº¦æ¡
        function resetProgressBar() {
            document.getElementById('segment-start').style.width = "0%";
            document.getElementById('segment-enter').style.width = "0%";
            document.getElementById('segment-pull').style.width = "0%";
        }

        async function loop(timestamp) {
            if (!isRunning) return;
            
            frameCount++;
            if (frameCount % FRAME_SKIP === 0) {
                webcam.update();
                await predict();
            }
            window.requestAnimationFrame(loop);
        }

        async function predict() {
            try {
                // å°†è§†é¢‘å¸§ç»˜åˆ¶åˆ°å¤„ç†ç”»å¸ƒ
                processCtx.drawImage(webcam.canvas, 0, 0);
                
                // å§¿åŠ¿ä¼°è®¡
                const { pose, posenetOutput } = await model.estimatePose(webcam.canvas);
                // åŠ¨ä½œåˆ†ç±»
                const prediction = await model.predict(posenetOutput);

                // æ›´æ–°é¢„æµ‹ç»“æœ
                let highestProb = 0;
                let currentAction = ACTIONS.NORMAL;
                
                for (let i = 0; i < maxPredictions; i++) {
                    const probability = prediction[i].probability;
                    const progress = document.getElementById(`progress-${i}`);
                    progress.style.width = `${probability * 100}%`;
                    
                    // æ‰¾å‡ºæ¦‚ç‡æœ€é«˜çš„åŠ¨ä½œ
                    if (probability > highestProb && probability > 0.7) {
                        highestProb = probability;
                        currentAction = Object.values(ACTIONS)[i];
                    }
                }
                
                // è®°å½•åŠ¨ä½œ
                if (highestProb > 0.7 && currentAction !== ACTIONS.NORMAL) {
                    const now = Date.now();
                    
                    // é¿å…é‡å¤è®°å½•ç›¸åŒçš„åŠ¨ä½œ
                    if (actionHistory.length === 0 || 
                        (actionHistory[actionHistory.length - 1].action !== currentAction || 
                         now - actionHistory[actionHistory.length - 1].time > 500)) {
                        
                        actionHistory.push({
                            action: currentAction,
                            time: now
                        });
                        
                        // æ£€æŸ¥åŠ¨ä½œåºåˆ—
                        checkActionSequence(currentAction, now);
                    }
                }
                
                // ç»˜åˆ¶å§¿åŠ¿åˆ°æ˜¾ç¤ºç”»å¸ƒ
                drawPose(pose);
            } catch (error) {
                console.error("é¢„æµ‹é”™è¯¯:", error);
            }
        }

        function checkActionSequence(currentAction, currentTime) {
            // å¦‚æœå½“å‰åŠ¨ä½œæ˜¯èµ·æ‰‹å¼ï¼Œå¼€å§‹æ–°çš„åºåˆ—
            if (currentAction === ACTIONS.START) {
                currentSequence = [currentAction];
                lastActionTime = currentTime;
                updateFeedback("æ£€æµ‹åˆ°èµ·æ‰‹å¼ï¼Œè¯·ç»§ç»­å®Œæˆåˆ’æ¡¨åŠ¨ä½œ", false);
                updateCurrentSequenceDisplay();
                updateCompletionProgress();
                return;
            }
            
            // å¦‚æœå·²ç»æœ‰èµ·æ‰‹å¼ï¼Œæ£€æŸ¥åç»­åŠ¨ä½œ
            if (currentSequence.length > 0 && currentSequence[0] === ACTIONS.START) {
                // æ£€æŸ¥æ˜¯å¦è¶…æ—¶
                if (currentTime - lastActionTime > SEQUENCE_TIMEOUT) {
                    updateFeedback("åŠ¨ä½œå¤ªæ…¢ï¼Œè¯·é‡æ–°å¼€å§‹åˆ’æ¡¨", false);
                    resetProgressBar();
                    currentSequence = [];
                    updateCurrentSequenceDisplay();
                    return;
                }
                
                // é¿å…é‡å¤æ·»åŠ ç›¸åŒçš„åŠ¨ä½œ
                if (currentSequence[currentSequence.length - 1] !== currentAction) {
                    // æ£€æŸ¥æ˜¯å¦ç¬¦åˆæ­£ç¡®çš„åºåˆ—é¡ºåº
                    if (currentSequence.length === 1 && currentAction === ACTIONS.ENTER) {
                        // èµ·æ‰‹å¼åæ¥çš„æ˜¯å…¥æ°´å¼ï¼Œæ­£ç¡®
                        currentSequence.push(currentAction);
                        lastActionTime = currentTime;
                        updateCurrentSequenceDisplay();
                        updateCompletionProgress();
                    } else if (currentSequence.length === 2 && currentAction === ACTIONS.PULL && 
                              currentSequence[1] === ACTIONS.ENTER) {
                        // èµ·æ‰‹å¼+å…¥æ°´å¼åæ¥çš„æ˜¯æ‹‰æ¡¨å¼ï¼Œæ­£ç¡®
                        currentSequence.push(currentAction);
                        lastActionTime = currentTime;
                        updateCurrentSequenceDisplay();
                        updateCompletionProgress();
                    } else {
                        // é”™è¯¯çš„åŠ¨ä½œé¡ºåº
                        updateFeedback("åŠ¨ä½œé¡ºåºä¸æ­£ç¡®ï¼Œè¯·æŒ‰ç…§èµ·æ‰‹â†’å…¥æ°´â†’æ‹‰æ¡¨çš„é¡ºåº", false);
                        resetProgressBar();
                        currentSequence = [];
                        updateCurrentSequenceDisplay();
                        return;
                    }
                }
                
                // æ£€æŸ¥åºåˆ—æ˜¯å¦å®Œæ•´
                if (arraysEqual(currentSequence, CORRECT_SEQUENCE)) {
                    updateFeedback("åŠ¨ä½œå®Œæ•´ä¸”æ­£ç¡®ï¼ğŸ‘", true);
                    completedCount++;
                    console.log(completedCount);
                    document.getElementById('completed-count').textContent = completedCount;
                    
                    // çŸ­æš‚æ˜¾ç¤ºå®Œæ•´è¿›åº¦åé‡ç½®
                    setTimeout(() => {
                        resetProgressBar();
                        currentSequence = [];
                        updateCurrentSequenceDisplay();
                        updateFeedback("å‡†å¤‡ä¸‹ä¸€æ¬¡åŠ¨ä½œè¯†åˆ«...", false);
                    }, 1500);
                } else {
                    updateFeedback(`å½“å‰åŠ¨ä½œ: ${currentAction}`, false);
                }
            }
        }

        function updateCurrentSequenceDisplay() {
            const sequenceElement = document.getElementById("current-sequence");
            if (currentSequence.length > 0) {
                sequenceElement.textContent = currentSequence.join(" â†’ ");
            } else {
                sequenceElement.textContent = "æ— ";
            }
        }

        function updateCompletionProgress() {
            const segmentStart = document.getElementById('segment-start');
            const segmentEnter = document.getElementById('segment-enter');
            const segmentPull = document.getElementById('segment-pull');
            
            // æ ¹æ®å½“å‰åºåˆ—æ›´æ–°è¿›åº¦æ˜¾ç¤º
            if (currentSequence.length === 1 && currentSequence[0] === ACTIONS.START) {
                segmentStart.style.width = "33.33%";
                segmentEnter.style.width = "0%";
                segmentPull.style.width = "0%";
            } else if (currentSequence.length === 2 && 
                      currentSequence[0] === ACTIONS.START && 
                      currentSequence[1] === ACTIONS.ENTER) {
                segmentStart.style.width = "33.33%";
                segmentEnter.style.width = "33.33%";
                segmentPull.style.width = "0%";
            } else if (currentSequence.length === 3 && 
                       currentSequence[0] === ACTIONS.START && 
                       currentSequence[1] === ACTIONS.ENTER && 
                       currentSequence[2] === ACTIONS.PULL) {
                segmentStart.style.width = "33.33%";
                segmentEnter.style.width = "33.33%";
                segmentPull.style.width = "33.33%";
            }
        }

        function arraysEqual(arr1, arr2) {
            if (arr1.length !== arr2.length) return false;
            for (let i = 0; i < arr1.length; i++) {
                if (arr1[i] !== arr2[i]) return false;
            }
            return true;
        }

        function updateFeedback(message, isCorrect) {
            const feedbackElement = document.getElementById("feedback");
            const sequenceElement = document.getElementById("action-sequence");
            if (message=="åŠ¨ä½œå®Œæ•´ä¸”æ­£ç¡®ï¼ğŸ‘") {
            	                    completedCount++;
                    console.log(completedCount);
                    document.getElementById('completed-count').textContent = completedCount;
            }
            feedbackElement.innerHTML = `<p>${message}</p>`;
            
            if (currentSequence.length > 0) {
                sequenceElement.innerHTML = `å½“å‰åºåˆ—: <span class="${isCorrect ? 'correct' : 'incorrect'}">${currentSequence.join(" â†’ ")}</span>`;
            } else {
                sequenceElement.innerHTML = "";
            }
            
            if (isCorrect) {
                feedbackElement.style.borderLeftColor = "#2ecc71";
            } else {
                feedbackElement.style.borderLeftColor = "#3498db";
            }
        }

        function drawPose(pose) {
            const canvas = document.getElementById("canvas");
            const processCanvas = document.getElementById("process-canvas");
            
            if (canvas && processCanvas) {
                // å°†å¤„ç†ç”»å¸ƒå†…å®¹æ”¾å¤§ç»˜åˆ¶åˆ°æ˜¾ç¤ºç”»å¸ƒ
                ctx.drawImage(processCanvas, 0, 0, canvas.width, canvas.height);
                
                if (pose) {
                    const minPartConfidence = 0.5;
                    // è°ƒæ•´å…³é”®ç‚¹å’Œéª¨æ¶çš„ç»˜åˆ¶æ¯”ä¾‹
                    const scale = canvas.width / processCanvas.width;
                    ctx.save();
                    ctx.scale(scale, scale);
                    tmPose.drawKeypoints(pose.keypoints, minPartConfidence, ctx);
                    tmPose.drawSkeleton(pose.keypoints, minPartConfidence, ctx);
                    ctx.restore();
                }
            }
        }
    </script>
</body>
</html>
